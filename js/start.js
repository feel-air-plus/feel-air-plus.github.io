var milkcocoa = new MilkCocoa("eggipdy4kpy.mlkcca.com");var groupDataStore = milkcocoa.dataStore("group");var userDataStore = milkcocoa.dataStore("user");var iconDataStore = milkcocoa.dataStore("icon");var groupList;var userListInSelectedGroup;window.onload = function(){    // 画面描画時    // グループデータストア内の項目を一覧で取得    groupDataStore.stream().sort("desc").next(function(err, datas) {        groupList = datas;        // 取得したグループ情報を画面のセレクトボックスに反映        datas.forEach(function(data) {            createGroupRow(data);        });    });    // ユーザデータストア内の項目を一覧で取得    userDataStore.stream().sort("desc").next(function(err, datas) {        userListInSelectedGroup = datas;    });    // アイコンデータストア内の項目を一覧で取得    iconDataStore.stream().sort("desc").next(function(err, datas) {        // 取得したアイコン情報を元に画面のラジオボタンに反映        datas.forEach(function(data) {            createIconRow(data);        });    });    // TODO:ラジオボタンデフォルト選択指定};function createGroupRow(data){    // グループのセレクトボックス要素を生成    $('.selectgroup').append(    '<option value="'    + data.value.groupName    + '">'    + data.value.groupName    + '</option>');};function createIconRow(data){    // アイコンのラジオボタン要素を生成    var iconName = data.value.iconName;    var iconUrl = "./img/"+data.value.url;    $('.icon-radio-row').append('<label class='    + iconName    + '>'    + '<input type="radio" name="iconStatus"'    + 'value="'    + data.value.iconId    + '" onClick="selectedImg()" ></label>');    $('.'+iconName).addClass("crobd");    $('.'+iconName).css('background', 'url('    + iconUrl    + ') no-repeat left top');};function enterChatMap() {    var groupEnterLimit = 4;    var selectedGroup = $(".selectgroup")[0].value;    var userName = $(".input__field")[0].value;    var selectedIcon = $("input[name='iconStatus']:checked").val();    var errorMessages = checkError(selectedGroup, userName, selectedIcon);    if (errorMessages.length > 0) {        alert(errorMessages);        // エラーメッセージ表示未対応        dispErrorMessages(errorMessages);        return;    }    // 選択しているグループの入室上限チェック    for(var i=0;i<groupList.length;i++){        if(groupList[i].value.groupName==selectedGroup){            if(groupList[i].value.count == groupEnterLimit){                alert("入室上限なり。");                // 暫定的にグループ入室上限に0をセット                groupDataStore.set(groupList[i].id, { 'count' : 0});                return;            }else{                // 入室上限を+1                var num = groupList[i].value.count + 1;                groupDataStore.set(groupList[i].id, { 'count' : num});            }        }    }    // ユーザIDを作成    // ユーザIDは1〜4までで作成する    var userIdLimit = 5;    var userId = 0;    var userIdInDataStoreArray = [];    userIdInDataStoreArray.push(0);     // 選択しているグループの中で現在使用されているユーザIDを配列で取得する    for(var i=0;i<userListInSelectedGroup.length;i++){        if (userListInSelectedGroup[i].value.groupId==selectedGroup) {            userIdInDataStoreArray.push(userListInSelectedGroup[i].value.userId);            console.log(userIdInDataStoreArray);        }    }    // 選択しているのグループの中のユーザID+1をユーザIDとして採番する    userId = Math.max.apply(null,userIdInDataStoreArray) + 1;    if(userId >= userIdLimit){        // alert("入室上限なり?");        // return;    }    // ユーザ情報をユーザデータストアに反映    userDataStore.push(        {            userId            : userId,            userName          : userName,            groupId           : selectedGroup,            iconId            : selectedIcon        },        function(err, pushed){        },        function(err) {            console.log("userDataStore push failed "+err);        }    )    // ユーザ情報をセッションストレージに格納    sessionStorage.clear('userInfo');    var userInfo = {        userId  : userId,        groupId : selectedGroup,        iconId  : selectedIcon    };    sessionStorage.setItem('userInfo', JSON.stringify(userInfo));    var chatMapUrl = "chatMap.html";    location.href = chatMapUrl;};function selectedImg() {	$('label').removeClass('selected');	var radioVal = $('input[name=iconStatus]:checked').val() - 1;	$('label:eq(' + radioVal + ')').addClass('selected');}// エラーチェックfunction checkError(groupId, userName, imgIcon) {    var errorMessages = [];    // グループの未選択チェック    if (!groupId.length) {        errorMessages.push("グループを選択してください。");    }    // 名前の未入力チェック    if (!userName.length) {        errorMessages.push("名前を入力してください。");    }    // アイコンの未選択チェック    if (!imgIcon) {        errorMessages.push("アイコンを選択してください。");    }    // 入力されたユーザ名文字数上限チェック    if(userName.length > 5){        errorMessages.push("ユーザ名が上限文字数(5文字)を超えています。");    }    return errorMessages;}// エラーメッセージの表示// 配列で受け取る// 配列の要素数だけ回してどこかに表示するfunction dispErrorMessages (errorMessages) {    return;}